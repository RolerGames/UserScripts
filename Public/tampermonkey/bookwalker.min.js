// ==UserScript==
// @name         BookWalker Cover Downloader
// @namespace    BookWalker Scripts
// @version      0.1
// @description  Select BookWalker covers on the https://bookwalker.jp/series/*/list/* or https://global.bookwalker.jp/series/* page and download them.
// @author       Roler
// @match        https://bookwalker.jp/series/*/list/*
// @match        https://global.bookwalker.jp/series/*
// @icon         https://www.google.com/s2/favicons?domain=bookwalker.jp
// @require      https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js
// @updateURL    https://raw.githubusercontent.com/RolerGames/UserScripts/master/Public/tampermonkey/bookwalker.min.js
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @connect      c.bookwalker.jp
// @run-at       document-end
// ==/UserScript==
!function(){"use strict";function o(c,i,o,e,a){const p=$("img.lazy");let w={},h=!1;function b(o){const e=$(".bookwalker-downloader#cover-download-error");e.removeClass("hidden").append("<p>Error: "+o+"</p>").animate({scrollTop:e.prop("scrollHeight")},"fast"),console.error(o)}function n(r,o){const s=$(".bookwalker-downloader.cover-download-button#"+r);s.html(`
                <a class="bookwalker-downloader">
                    <span id="cover-download-text" class="bookwalker-downloader">`+o+`</span>
                    <span id="cover-download-status" class="bookwalker-downloader hidden"></span>
                    <span id="cover-download-progress" class="bookwalker-downloader hidden"></span>                        
                    <span id="cover-download-percent" class="bookwalker-downloader hidden"></span>
                </a>
            `),s.on("click",function(){if(!1===h){const t=$(".bookwalker-downloader.cover-selected"),d=/[\\\/:"*?<>|]/gi;function e(o,e){s.children("a").children('span[id="cover-download-text"]').addClass("hidden"),s.children("a").children('span[id="cover-download-status"]').removeClass("hidden").html("<p>"+e+"</p>"),s.children("a").children('span[id="cover-download-progress"]').removeClass("hidden").html('<progress max="100" value="0"></progress>').children("progress").val(o),s.children("a").children('span[id="cover-download-percent"]').removeClass("hidden").html("<br>"+Math.round(100*o)/100+"%"),100<=o&&(s.children("a").children('span[id="cover-download-text"]').removeClass("hidden"),s.children("a").children('span[id="cover-download-status"]').addClass("hidden").html(""),s.children("a").children('span[id="cover-download-progress"]').addClass("hidden").html(""),s.children("a").children('span[id="cover-download-percent"]').addClass("hidden").html(""))}function o(){const o=new JSZip;t.each(function(){var l;o.file($(this).attr("title").replace(d,"")+".jpg",(l=w["https://c.bookwalker.jp/coverImage_"+(parseInt($(this).attr(c).split("/")[3].split("").reverse().join(""))-1)+".jpg"],new Promise(function(a,n){JSZipUtils.getBinaryContent(l,function(o,e){o?(n(o),b(o.replace("Error: ","")+" "+l)):a(e)})})),{binary:!0})}),o.generateAsync({type:"blob",streamFiles:!0},function(o){e(o.percent,"Zipping covers...")}).then(function(o){saveAs(o,i.replace(d,"")+".zip")})}function a(){if(Object.keys(w).length>=t.length)try{"cover-download-as-jpeg"===r?t.each(function(){saveAs(w["https://c.bookwalker.jp/coverImage_"+(parseInt($(this).attr(c).split("/")[3].split("").reverse().join(""))-1)+".jpg"],$(this).attr("title").replace(d,"")+".jpg")}):"cover-download-as-zip"===r&&o()}catch(o){b(o.message)}finally{w={},h=!1,e(100,"")}else setTimeout(a,100)}if("cover-select-all"===r)"Deselect All"===s.children("a").children('span[id="cover-download-text"]').text()?(t.each(function(){$(this).removeClass("cover-selected")}),s.children("a").children('span[id="cover-download-text"]').text("Select All")):"Select All"===s.children("a").children('span[id="cover-download-text"]').text()&&(p.each(function(){$(this).addClass("cover-selected")}),s.children("a").children('span[id="cover-download-text"]').text("Deselect All"));else if(0<t.length){h=!0;try{function n(o){200===o.status&&o.finalUrl.indexOf(/https:\/\/c.bookwalker.jp\/coverImage_.[0-9]*.jpg/g)||b(o.status+" "+o.statusText+" "+o.finalUrl),w[o.finalUrl]=window.URL.createObjectURL(o.response),e(Object.keys(w).length/t.length*100,"Downloading covers...")}function l(o){b(o.status+" "+o.statusText+" "+o.finalUrl)}t.each(function(){GM_xmlhttpRequest({method:"GET",url:"https://c.bookwalker.jp/coverImage_"+(parseInt($(this).attr(c).split("/")[3].split("").reverse().join(""))-1)+".jpg",responseType:"blob",onload:n,onabort:l,onerror:l,ontimeout:l})})}catch(o){h=!1,b(o.message)}finally{e(100,"")}a()}}})}o.before('<div id="cover-download-button-container" class="bookwalker-downloader">'+e+'<p id="cover-download-error" class="bookwalker-downloader hidden"></p></div>'),p.each(function(){$(this).addClass("bookwalker-downloader"),$(this).removeClass("cover-selected").parent().removeAttr("href").addClass("bookwalker-downloader"),$(this).on("click",function(){!1===h&&($(this).hasClass("cover-selected")?$(this).removeClass("cover-selected"):$(this).addClass("cover-selected"))})}),n("cover-download-as-jpeg","Download Selected Covers as JPEG"),n("cover-download-as-zip","Download Selected Covers as ZIP"),n("cover-select-all","Select All"),GM_addStyle(a+`
            div.bookwalker-downloader#cover-download-button-container {
                width: 100%; 
                text-align: center;
            }
            img.lazy.bookwalker-downloader {
                opacity: 0.5;
            }
            img.lazy.bookwalker-downloader.cover-selected {
                opacity: 1;
            }
            .bookwalker-downloader.hidden {
                display: none;
            }
            a.bookwalker-downloader {
                text-decoration: none;
                cursor: pointer;
            }
            p.bookwalker-downloader#cover-download-error {
                color: red;
                max-height: 60px;
                overflow-y: scroll;
                margin: 10px;
            }
        `)}-1<window.location.href.search(/https:\/\/bookwalker.jp\/series\/.*\/list\/.*/gi)?o("data-original",$(".o-contents-section__title").text(),$(".o-contents-section__body").first(),`<button id="cover-download-as-jpeg" class="a-basic-btn--secondary bookwalker-downloader cover-download-button"></button>
            <button id="cover-download-as-zip" class="a-basic-btn--secondary bookwalker-downloader cover-download-button"></button>
            <button id="cover-select-all" class="a-basic-btn--secondary bookwalker-downloader cover-download-button"></button>
            `,`
            button.bookwalker-downloader.cover-download-button {
                margin: 10px;
                display: inline-block;
            }
        `):-1<window.location.href.search(/https:\/\/global.bookwalker.jp\/series\/.*/gi)&&o("data-srcset",$(".title-main-inner").text().split("\n                            ")[1],$(".o-tile-list").first(),`<p id="cover-download-as-jpeg" class="btn-cart-add btn-box m-b40 bookwalker-downloader cover-download-button"></p>
            <p id="cover-download-as-zip" class="btn-cart-add btn-box m-b40 bookwalker-downloader cover-download-button"></p>
            <p id="cover-select-all" class="btn-cart-add btn-box m-b40 bookwalker-downloader cover-download-button"></p>
            `,`
            p.bookwalker-downloader.cover-download-button {
                cursor: pointer; 
                display: inline-block;
            }
        `)}();